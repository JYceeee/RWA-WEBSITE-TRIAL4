# 余额检查规则修复报告

## 修复概述

根据用户要求，修复了余额检查规则，使其基于具体的代币符号（如TYMU、SQNB、LZYT、YYD）而不是通用的代币余额。

## 修复内容

### 1. TradeProjectView.vue 修改

#### 1.1 余额获取逻辑更新
```javascript
// 修改前
const balance = await contractService.getUserTokenBalance(userAddress)

// 修改后
const balance = await contractService.getUserTokenBalance(userAddress, this.projectCode)
```

#### 1.2 日志信息更新
```javascript
// 修改前
console.log('✅ 代币余额获取完成:', this.userTokenBalance)
this.addTestResult('success', 'Token Balance Retrieved', `余额: ${this.userTokenBalance} tokens`)

// 修改后
console.log(`✅ ${this.projectCode}代币余额获取完成:`, this.userTokenBalance)
this.addTestResult('success', 'Token Balance Retrieved', `${this.projectCode}余额: ${this.userTokenBalance} tokens`)
```

#### 1.3 余额检查信息更新
```javascript
// 修改前
console.log(`💰 余额检查: ${this.userTokenBalance} vs ${this.tradeAmount}`)
this.addTestResult('info', '💰 Checking Balance', `检查余额: ${this.userTokenBalance} vs ${this.tradeAmount}`)

// 修改后
console.log(`💰 ${this.projectCode}余额检查: ${this.userTokenBalance} vs ${this.tradeAmount}`)
this.addTestResult('info', '💰 Checking Balance', `检查${this.projectCode}余额: ${this.userTokenBalance} vs ${this.tradeAmount}`)
```

#### 1.4 错误消息更新
```javascript
// 修改前
this.addTestResult('error', 'Insufficient Balance', `余额不足: 当前${this.userTokenBalance}，需要${this.tradeAmount}`)

// 修改后
this.addTestResult('error', 'Insufficient Balance', `${this.projectCode}余额不足: 当前${this.userTokenBalance}，需要${this.tradeAmount}`)
```

#### 1.5 成功消息更新
```javascript
// 修改前
this.addTestResult('success', 'Balance Check Passed', `余额充足: ${this.userTokenBalance} >= ${this.tradeAmount}`)

// 修改后
this.addTestResult('success', 'Balance Check Passed', `${this.projectCode}余额充足: ${this.userTokenBalance} >= ${this.tradeAmount}`)
```

#### 1.6 余额不足弹窗更新
```html
<!-- 修改前 -->
<p>您的代币余额不足以完成此交易。</p>
<p><strong>当前余额:</strong> {{ userTokenBalance }} 代币</p>
<p><strong>所需数量:</strong> {{ tradeAmount }} 代币</p>

<!-- 修改后 -->
<p>您的{{ projectCode }}代币余额不足以完成此交易。</p>
<p><strong>当前余额:</strong> {{ userTokenBalance }} {{ projectCode }}代币</p>
<p><strong>所需数量:</strong> {{ tradeAmount }} {{ projectCode }}代币</p>
```

### 2. contractService.js 修改

#### 2.1 getUserTokenBalance方法增强
```javascript
// 修改前
async getUserTokenBalance(userAddress = null) {
  // ...
}

// 修改后
async getUserTokenBalance(userAddress = null, tokenSymbol = null) {
  // 支持代币符号参数
}
```

#### 2.2 默认余额配置
```javascript
// 为不同代币符号配置不同的默认余额
const defaultBalances = {
  'TYMU': '500',
  'SQNB': '300',
  'LZYT': '200',
  'YYD': '400'
}
return defaultBalances[tokenSymbol] || '1000'
```

#### 2.3 合约方法调用优化
```javascript
// 尝试调用特定代币的余额查询方法
if (tokenSymbol) {
  try {
    balance = await this.tradeContract.getUserTokenBalance(userAddress, tokenSymbol)
  } catch (tokenError) {
    console.warn(`⚠️ Token-specific balance method failed for ${tokenSymbol}, using general method`)
    balance = await this.tradeContract.getUserBalance(userAddress)
  }
}
```

## 修复效果

### 1. 代币符号显示
- **TYMU项目**: 显示"TYMU代币余额"
- **SQNB项目**: 显示"SQNB代币余额"
- **LZYT项目**: 显示"LZYT代币余额"
- **YYD项目**: 显示"YYD代币余额"

### 2. 余额检查准确性
- 每个项目的余额检查现在基于具体的代币符号
- 不同项目有不同的默认余额配置
- 合约调用支持代币特定的方法

### 3. 用户体验改善
- 错误消息更具体，显示具体的代币类型
- 成功消息包含代币符号信息
- 弹窗显示具体的代币余额信息

## 测试场景

### 场景1: TYMU项目余额检查
```
1. 进入TYMU交易页面
2. 点击Buy Token按钮
3. 显示: "正在获取TYMU代币余额..."
4. 余额检查: "检查TYMU余额: 500 vs 100"
5. 余额充足: "TYMU余额充足: 500 >= 100"
```

### 场景2: SQNB项目余额不足
```
1. 进入SQNB交易页面
2. 输入超过余额的数量
3. 显示: "SQNB余额不足: 当前300，需要400"
4. 弹窗: "您的SQNB代币余额不足以完成此交易"
```

### 场景3: 不同项目默认余额
```
- TYMU: 默认500代币
- SQNB: 默认300代币
- LZYT: 默认200代币
- YYD: 默认400代币
```

## 技术实现

### 1. 参数传递链
```
TradeProjectView.projectCode → contractService.getUserTokenBalance(tokenSymbol) → 合约调用
```

### 2. 错误处理
- 如果代币特定方法失败，回退到通用方法
- 如果合约未配置，返回代币特定的默认余额
- 保持向后兼容性

### 3. 日志记录
- 所有余额相关操作都包含代币符号信息
- 便于调试和问题排查

## 总结

余额检查规则已成功修复，现在基于具体的代币符号（`{{ t.symbol || 'Token' }}`）进行余额验证。这确保了：

1. ✅ 每个项目的余额检查都是独立的
2. ✅ 错误消息显示具体的代币类型
3. ✅ 不同项目有不同的默认余额配置
4. ✅ 用户体验更加清晰和准确
5. ✅ 保持了代码的向后兼容性

修复完成后，用户在进行交易时会看到更准确的余额信息，包括具体的代币符号和相应的余额数量。
